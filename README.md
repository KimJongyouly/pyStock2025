# 🚀 AWS EC2 자동매매 봇 (MACD + 일목균형표 + 텔레그램 + KST 시간)

이 봇은 트레이딩뷰 웹훅 신호를 받아 **MACD 변곡**과 **일목균형표 터치**를 동시에 만족할 때 매매를 기록하고, **텔레그램으로 실시간 알림**을 보냅니다. 모든 시간 기록은 **KST(한국 시간, UTC+9)** 기준으로 자동 변환되어 표시됩니다.

**✨ 주요 기능:**
- 매매 체결 시 즉시 텔레그램 알림
- 매매 없어도 15분마다 현황 보고 알림 (현재가격, MACD, 일목터치 여부 등)
- 처음 보는 종목 자동 등록 (NQ, GC 외에도 MNQ, ES 등 자동 지원)

---

## 1. 🛠️ 필수 설치 (최초 1회)

```bash
# 시스템 업데이트 및 pip 설치
sudo apt update
sudo apt install python3-pip -y

# 필수 라이브러리 설치
# - flask: 웹훅 서버 구동
# - python-dotenv: 환경 변수 관리
# - requests: 텔레그램 API 호출
# - pytz: 한국 시간(KST) 변환 처리
sudo pip install flask python-dotenv requests pytz --break-system-packages
```

---

## 2. 🔑 환경 변수 설정 (.env)

봇의 비밀번호, 포트, 텔레그램 키를 설정합니다.

```bash
nano .env
```

**[필수 입력 내용]**

```ini
WEBHOOK_SECRET=lisa1234
FLASK_PORT=80
TELEGRAM_TOKEN=내_텔레그램_토큰
TELEGRAM_CHAT_ID=내_챗_아이디
```

### 텔레그램 토큰 및 Chat ID 발급 방법

1. **텔레그램 봇 생성**: [@BotFather](https://t.me/botfather)에게 `/newbot` 명령어 전송
2. **토큰 받기**: BotFather가 제공하는 토큰을 `TELEGRAM_TOKEN`에 입력
3. **Chat ID 확인**: [@userinfobot](https://t.me/userinfobot)에게 메시지 전송하여 Chat ID 확인

### 저장하고 나오기
* `Ctrl` + `O` (저장) → `Enter` → `Ctrl` + `X` (종료)

---

## 3. 🤖 봇 실행 및 관리 명령어

### ✅ 봇 켜기 (무중단 실행)
봇을 끄고 다시 켤 때는 이 두 줄을 항상 세트로 입력하세요.

```bash
sudo pkill python
nohup sudo python3 app.py > output.log 2>&1 &
```

### 📺 실시간 로그 확인 (CCTV)
봇이 잘 돌아가는지, 에러는 없는지 확인할 때 씁니다. (나가기: Ctrl+C)
모든 로그 시간은 KST(한국 시간) 기준으로 표시됩니다.

```bash
tail -f output.log
```

### 📊 매매 장부 확인
실제로 체결된 매수/매도 기록을 봅니다. (모든 시간은 KST 기준)

```bash
cat logs/trades.csv
```

### 🧹 장부 초기화 (기록 삭제)
테스트 기록을 싹 지우고 새로 시작하고 싶을 때 씁니다.

```bash
sudo pkill python            # 1. 봇 끄기
sudo rm -f logs/trades.csv   # 2. 장부 강제 삭제
nohup sudo python3 app.py > output.log 2>&1 &  # 3. 봇 다시 켜기
```

---

## 4. 📨 트레이딩뷰(TradingView) 알림 설정

### A. 일목균형표 데이터 (매매 X, 데이터 수집용)
**조건**: 매 캔들 종가(Once per bar close)

**메시지**:

```json
{
  "secret": "lisa1234",
  "type": "ICHIMOKU_SET_1",
  "ticker": "{{ticker}}",
  "tenkan": "{{plot_0}}",
  "kijun": "{{plot_1}}",
  "chikou": "{{plot_2}}",
  "senkou_a": "{{plot_3}}",
  "senkou_b": "{{plot_4}}"
}
```

### B. MACD 신호 (매매 판단 트리거)
**조건**: 매 캔들 종가(Once per bar close)

**메시지**:

```json
{
  "secret": "lisa1234",
  "type": "MACD_REPORT",
  "ticker": "{{ticker}}",
  "high": "{{high}}",
  "low": "{{low}}",
  "close": "{{close}}",
  "macd_value": "{{plot_0}}",
  "signal_value": "{{plot_1}}"
}
```

---

## 5. 🧠 매매 전략 로직

### MACD 변곡 감지:
- **매수(BUY)**: MACD 값이 음수(-)에서 양수(+)로 변할 때 (골든크로스)
- **매도(SELL)**: MACD 값이 양수(+)에서 음수(-)로 변할 때 (데드크로스)

### 일목균형표 필터:
- 현재 캔들의 고가(High)와 저가(Low) 사이에 일목균형표 5개 라인 중 하나라도 터치하고 있어야 함.

### 결과:
- **매매 조건 만족 시** (두 조건 모두 맞을 때):
  1. `logs/trades.csv`에 기록 (KST 시간 기준)
  2. 터미널에 로그 출력 (KST 시간 기준)
  3. **텔레그램으로 매매 체결 알림 발송** 📱 (KST 시간 기준)

- **매매 조건 불만족 시**:
  - **텔레그램으로 현황 보고 알림 발송** 📊 (현재가격, MACD, 일목터치 여부 등)

---

## 6. 📱 텔레그램 알림 기능

### A. 매매 체결 알림
매매가 체결될 때마다 `log_trade()` 함수가 자동으로 다음 작업을 수행합니다:

1. **CSV 파일 저장**: `logs/trades.csv`에 거래 내역 기록 (KST 시간)
2. **터미널 로그 출력**: 실시간 로그 확인 (KST 시간)
3. **텔레그램 알림 전송**: 핸드폰으로 즉시 알림 수신 (KST 시간)

**매매 체결 알림 메시지 형식:**
```
🚀 [자동매매 알림]

종목: NQ
주문: BUY
가격: 18500.25
시간: 2024-01-15 14:30:45  (KST 기준)
사유: MACD양전 + 일목터치
```

### B. 현황 보고 알림 (새로운 기능!)
매매 조건이 맞지 않아 매매가 체결되지 않은 경우에도, **15분마다 웹훅 데이터가 들어올 때마다** 현재 상황을 텔레그램으로 보고합니다.

**발송 조건:**
- MACD_REPORT 웹훅이 수신되었지만 매매 조건 불만족 시
- MACD 초기화 중이거나 일목균형표 데이터 대기 중일 때

**현황 보고 메시지 형식:**
```
📊 [현황 보고]

종목: NQ
시간: 2024-01-15 14:30:45

현재가격: 18500.25
현재MACD: 0.1234
이전MACD: -0.0567
시그널: 0.0890
일목터치: 일목터치(O)

결론: 조건 불만족
```

**현황 보고의 장점:**
- ✅ 매매가 없어도 봇이 정상 작동 중임을 확인 가능
- ✅ 현재 시장 상황을 실시간으로 모니터링
- ✅ MACD 변곡점 도달 여부를 사전에 파악 가능
- ✅ 일목균형표 터치 여부를 확인하여 매매 타이밍 준비

### 기술 구현
- **라이브러리**: `requests` 라이브러리를 사용하여 텔레그램 Bot API 호출
- **에러 처리**: 텔레그램 전송 실패 시 에러 로그 기록 (봇은 계속 동작)
- **환경 변수**: `.env` 파일에서 `TELEGRAM_TOKEN`과 `TELEGRAM_CHAT_ID` 자동 로드
- **시간 표시**: 모든 시간은 KST(한국 시간, UTC+9) 기준으로 자동 변환되어 표시
- **중복 방지**: 매매 체결 시에는 현황 보고를 전송하지 않아 중복 알림 방지

---

## 7. 📂 파일 구조

```
auto-trade-python/
├── app.py              # 메인 애플리케이션
│                       # - 매매 로직 (MACD + 일목균형표)
│                       # - 텔레그램 알림 (매매 체결 + 현황 보고)
│                       # - KST 시간 처리
│                       # - 새로운 종목 자동 등록
├── .env                # 환경 변수 설정 파일
├── README.md           # 사용 설명서
├── logs/               # 거래 기록 저장 폴더
│   └── trades.csv      # 매매 체결 내역 (CSV 형식, KST 시간 기준)
└── output.log          # 봇 실행 로그 (KST 시간 기준)
```

---

## 8. ⏰ KST(한국 시간) 자동 적용 기능

### 개요
AWS EC2 서버는 기본적으로 UTC 시간대를 사용하지만, 이 봇은 모든 시간 기록을 **KST(한국 시간, UTC+9)**로 자동 변환하여 표시합니다.

### 적용 범위
다음 모든 시간 기록이 KST 기준으로 표시됩니다:

1. **터미널 로그 시간**
   - 모든 로그 메시지의 타임스탬프가 KST로 표시
   - 예: `2024-01-15 14:30:45 - ✨ [매매 체결] NQ BUY @ 18500.25`

2. **CSV 파일 시간**
   - `logs/trades.csv`의 '시간' 컬럼이 KST로 기록
   - 예: `2024-01-15 14:30:45`

3. **텔레그램 알림 시간**
   - 알림 메시지 본문의 시간이 KST로 표시
   - 예: `시간: 2024-01-15 14:30:45`

### 기술 구현
- **라이브러리**: `pytz` 라이브러리를 사용하여 타임존 처리
- **타임존 설정**: `Asia/Seoul` (KST, UTC+9) 명시적 적용
- **커스텀 포맷터**: 로깅 시스템에 `KSTFormatter` 클래스를 적용하여 모든 로그 시간을 KST로 변환
- **헬퍼 함수**: `get_kst_now()` 함수로 일관된 KST 시간 반환

### 장점
- ✅ 서버가 UTC 시간대여도 한국 시간으로 일관되게 표시
- ✅ 로그, CSV, 텔레그램 알림의 시간이 모두 동일한 기준으로 표시
- ✅ 한국 거래 시간대와 직접 대응하여 분석이 용이

---

## 9. 🆕 새로운 종목 자동 등록 기능

### 개요
기존에는 `market_state`에 미리 정의된 종목(NQ, GC)만 처리했습니다. 이제는 **처음 보는 종목이 들어오면 자동으로 등록**하여 즉시 처리할 수 있습니다.

### 동작 방식
1. **새 종목 감지**: 웹훅으로 들어온 종목명이 `market_state`에 없을 때
2. **자동 등록**: `{'prev_macd': None, 'ichimoku': {}}` 구조로 즉시 초기화
3. **로그 출력**: `🆕 새로운 종목 감지: {ticker} (자동 등록 완료)` 메시지 출력
4. **정상 처리**: 등록 직후부터 일목균형표/MACD 데이터를 정상적으로 처리

### 지원 종목 예시
- **NQ, GC**: 기존부터 지원
- **MNQ**: 자동 등록되어 즉시 지원
- **ES, YM, CL**: 자동 등록되어 즉시 지원
- **기타 모든 종목**: 정규화된 종목명으로 자동 등록

### 종목명 정규화
트레이딩뷰에서 오는 종목명을 자동으로 정규화합니다:
- `MNQ1!` → `MNQ`
- `GC1!` → `GC`
- `NQ1!` → `NQ`

### 장점
- ✅ 종목 추가 시 코드 수정 불필요
- ✅ 실시간으로 새로운 종목 모니터링 시작
- ✅ 여러 종목을 동시에 자동 관리

---

## 10. 🔍 주요 기능

- ✅ **MACD 골든크로스/데드크로스 감지** - MACD 값의 변곡점을 정확히 감지
- ✅ **일목균형표 터치 필터링** - 일목균형표 라인 터치 여부로 신호 필터링
- ✅ **CSV 파일 자동 기록** - 모든 매매 내역을 CSV 파일로 자동 저장 (KST 시간)
- ✅ **실시간 터미널 로그** - 상세한 로그를 터미널에 실시간 출력 (KST 시간)
- ✅ **매매 체결 알림** - 매매 체결 시 즉시 텔레그램으로 알림 발송 (KST 시간)
- ✅ **현황 보고 알림** - 매매 없어도 15분마다 현재 상황을 텔레그램으로 보고 (새로 추가!)
- ✅ **새로운 종목 자동 등록** - 처음 보는 종목이 들어오면 자동으로 등록하여 즉시 처리 (새로 추가!)
- ✅ **웹훅 보안 인증** - WEBHOOK_SECRET으로 무단 접근 차단
- ✅ **다중 종목 지원** - NQ, GC, MNQ 등 여러 종목 동시 모니터링 (자동 확장)
- ✅ **KST(한국 시간) 자동 적용** - 모든 시간 기록이 한국 시간(UTC+9) 기준으로 자동 변환

---

이제 언제든지 터미널에서 **`cat README.md`** 라고 치시면 이 사용설명서를 다시 볼 수 있습니다! 
이 파일은 봇 동작에 영향을 주지 않는 '메모장'이니 안심하고 두셔도 됩니다.



## 11. .env
- 데이터는 따로 배포가 되지 않으므로... 
- 파일위치  project_root에 .env만들면 됨. 
- 실제 소스를 보고 필요하다고 판단되는 것들을 리스팅 한 부분이므로 참고 
```
# every 1 min
TICKTIME=1

# timezone
TIMEZONE=Asia/Seoul

# Flask 설정
FLASK_HOST=0.0.0.0
FLASK_PORT=5050
FLASK_DEBUG=True

# 로그 설정(size단위는 MB)
# trades.csv ==> sqlite3으로 변경
# trades.db :
#   my_stocks : 관심가주, 투자했주, 관심꺼주, 모의했주
#   revenue : 모의했주, 관심가주, 투자했주의 수익율 계산 (일, 주, 월)
LOG_DIR=logs
LOG_SIZE=5
BACKP_COUNT=5
INFO_LOG=info.log
ERROR_LOG=error.log
SQLITE3=trades.db

# 웹훅 보안 (선택사항)
WEBHOOK_SECRET=


# 기본 거래 설정
DEFAULT_SYMBOL=ES
DEFAULT_QUANTITY=1

# telegram
TELEGRAM_URL=https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage
TELEGRAM_TOKEN=
TELEGRAM_CHAT_ID=
```